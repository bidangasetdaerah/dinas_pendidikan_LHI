<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>LAPORAN LHI DINAS PENDIDIKAN DAN KEBUDAYAAN</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen p-6 transition-colors duration-300">
  <div class="max-w-7xl mx-auto bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6">
    <!-- Header + Dark Mode -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
        üìä Data LHI Peralatan Dan Mesin
      </h2>
      <button id="toggleDark"
        class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
        üåô
      </button>
    </div>

    <!-- Search -->
    <div class="flex justify-between items-center mb-3">
      <input type="text" id="searchBox" placeholder="üîç Cari data..."
        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
               focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm
               bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 w-64" />
    </div>

    <!-- Tabel -->
    <div class="overflow-x-auto border rounded-lg shadow-sm">
      <table id="dataTable" class="min-w-[1500px] w-full text-sm text-center border-collapse">
        <thead></thead>
        <tbody class="text-gray-800 dark:text-gray-100 text-xs"></tbody>
      </table>
    </div>

    <!-- Pagination + Export -->
    <div class="flex justify-between items-center mt-4 text-sm">
      <span id="pageInfo" class="text-gray-600 dark:text-gray-300">Halaman 1</span>
      <div class="flex gap-2">
        <button id="prevPage"
          class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
          ‚óÄÔ∏è
        </button>
        <button id="nextPage"
          class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
          ‚ñ∂Ô∏è
        </button>
        <button id="downloadExcel"
          class="px-3 py-1 rounded bg-green-600 text-white font-semibold hover:bg-green-700">
          ‚¨áÔ∏è Excel
        </button>
        <button id="downloadPDF"
          class="px-3 py-1 rounded bg-red-600 text-white font-semibold hover:bg-red-700">
          ‚¨áÔ∏è PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Export Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable"></script>

  <script>
    const tbody = document.querySelector("tbody");
    const thead = document.querySelector("thead");
    const searchBox = document.getElementById("searchBox");
    const pageInfo = document.getElementById("pageInfo");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    // Link CSV Google Sheets
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7sTDwqB-dKMbt6-E6ux3C-_8F48Au-bJJcxqAs8ZiEcf4duOII3G2uE9Y6Psu8xIMkBnvvqMXCkzR/pub?gid=0&single=true&output=csv";

    const formatNumber = (value) => {
      if (typeof value === "number") return new Intl.NumberFormat("id-ID").format(value);
      if (!isNaN(value) && value !== "") return new Intl.NumberFormat("id-ID").format(Number(value));
      return value ?? "";
    };

    // üîπ Render header dengan merge A+B & I-K
    function renderHeader(rows) {
      thead.innerHTML = "";

      const top = rows[0].slice(0, 20);
      const bottom = rows[1].slice(0, 20);

      // Baris pertama
      const tr1 = document.createElement("tr");
      top.forEach((h, i) => {
        if (i === 0) { // Merge A+B
          const th = document.createElement("th");
          th.colSpan = 2;
          th.className = "border p-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200";
          th.textContent = h;
          tr1.appendChild(th);
        } else if (i === 8) { // Merge I-K
          const th = document.createElement("th");
          th.colSpan = 3;
          th.className = "border p-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200";
          th.textContent = h;
          tr1.appendChild(th);
        } else if (i !== 1 && i !== 9 && i !== 10) {
          const th = document.createElement("th");
          th.rowSpan = 2;
          th.className = "border p-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200";
          th.textContent = h;
          tr1.appendChild(th);
        }
      });

      // Baris kedua
      const tr2 = document.createElement("tr");
      // A+B
      for (let j = 0; j <= 1; j++) {
        const th = document.createElement("th");
        th.className = "border p-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200";
        th.textContent = bottom[j];
        tr2.appendChild(th);
      }
      // I‚ÄìK
      for (let j = 8; j <= 10; j++) {
        const th = document.createElement("th");
        th.className = "border p-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200";
        th.textContent = bottom[j];
        tr2.appendChild(th);
      }

      thead.appendChild(tr1);
      thead.appendChild(tr2);
    }

    function renderTable() {
      tbody.innerHTML = "";
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredData.slice(start, end);

      pageData.forEach((row) => {
        const tr = document.createElement("tr");
        tr.classList.add("hover:bg-gray-50", "dark:hover:bg-gray-700");

        row.slice(0, 20).forEach((cell, index) => {
          const td = document.createElement("td");
          td.className = "border p-2";
          td.textContent = (index === 13 || index === 14) ? formatNumber(cell) : (cell ?? "");
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      pageInfo.textContent = `Halaman ${currentPage} dari ${Math.ceil(filteredData.length / rowsPerPage)}`;
    }

    function applySearch() {
      const keyword = searchBox.value.toLowerCase();
      filteredData = allData.filter(row => row.some(cell => (cell + "").toLowerCase().includes(keyword)));
      currentPage = 1;
      renderTable();
    }

    searchBox.addEventListener("input", applySearch);
    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });
    nextPageBtn.addEventListener("click", () => {
      if (currentPage < Math.ceil(filteredData.length / rowsPerPage)) {
        currentPage++;
        renderTable();
      }
    });

    // Auto load Google Sheets
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const rows = text.split("\n").map(r => r.split(",").map(c => c.trim()));

        // Render header dari A1:T1 + A2:T2
        renderHeader([rows[0], rows[1]]);

        // Data mulai baris ketiga (A3:T...)
        allData = rows.slice(2).map(r => r.slice(0, 20));
        filteredData = [...allData];

        renderTable();
      } catch (err) {
        console.error("Gagal load sheet:", err);
      }
    });

    // Export ke Excel
    document.getElementById("downloadExcel").addEventListener("click", () => {
      const ws = XLSX.utils.aoa_to_sheet(allData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data");
      XLSX.writeFile(wb, "data.xlsx");
    });

    // Export ke PDF
    document.getElementById("downloadPDF").addEventListener("click", () => {
      const doc = new jsPDF('l', 'mm', 'a4');
      doc.text("Data Barang", 14, 10);
      doc.autoTable({
        head: [rows[1].slice(0, 20)], // pake baris kedua biar rapih
        body: filteredData,
        startY: 15,
        styles: { fontSize: 7 },
        headStyles: { fillColor: [41, 128, 185] }
      });
      doc.save("data.pdf");
    });

    // Dark mode toggle
    document.getElementById("toggleDark").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      document.getElementById("toggleDark").textContent =
        document.documentElement.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    });
  </script>
</body>
</html>
