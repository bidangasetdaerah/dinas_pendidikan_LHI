<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>LAPORAN LHI DINAS PENDIDIKAN DAN KEBUDAYAAN</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen p-6 transition-colors duration-300">
  <div class="max-w-7xl mx-auto bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6">
    <!-- Header + Dark Mode -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
        üìä Data LHI Peralatan Dan Mesin
      </h2>
      <button id="toggleDark"
        class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
        üåô
      </button>
    </div>

    <!-- Search -->
    <div class="flex justify-between items-center mb-3">
      <input type="text" id="searchBox" placeholder="üîç Cari data..."
        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm
               focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm
               bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 w-64" />
    </div>

    <!-- Tabel -->
    <div class="overflow-x-auto border rounded-lg shadow-sm">
      <table id="dataTable" class="min-w-[1500px] w-full text-sm text-center border-collapse">
        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
          <tr>
            <th colspan="2" class="border p-2">Penggolongan dan Kodefikasi Barang</th>
            <th rowspan="2" class="border p-2">NIBAR</th>
            <th rowspan="2" class="border p-2">Nomor Register</th>
            <th rowspan="2" class="border p-2">Spesifikasi Nama Barang</th>
            <th rowspan="2" class="border p-2">Spesifikasi Lainnya</th>
            <th rowspan="2" class="border p-2">Merek/Tipe</th>
            <th rowspan="2" class="border p-2">Lokasi</th>
            <th colspan="3" class="border p-2">Kendaraan Dinas*)</th>
            <th rowspan="2" class="border p-2">Jumlah</th>
            <th rowspan="2" class="border p-2">Satuan</th>
            <th rowspan="2" class="border p-2">Harga Satuan Perolehan<br>(Rp.)</th>
            <th rowspan="2" class="border p-2">Nilai Perolehan<br>(Rp.)</th>
            <th rowspan="2" class="border p-2">Cara Perolehan</th>
            <th rowspan="2" class="border p-2">Tanggal Perolehan</th>
            <th rowspan="2" class="border p-2">Status Penggunaan</th>
            <th rowspan="2" class="border p-2">Keterangan</th>
            <th rowspan="2" class="border p-2">Nama Kecamatan</th>
            <th rowspan="2" class="border p-2">Konfirmasi Keberadaan</th>
          </tr>
          <tr>
            <th class="border p-2">Kode Barang</th>
            <th class="border p-2">Nama Barang</th>
            <th class="border p-2">Nomor Polisi</th>
            <th class="border p-2">Nomor Rangka</th>
            <th class="border p-2">Nomor BPKB</th>
          </tr>
        </thead>
        <tbody class="text-gray-800 dark:text-gray-100 text-xs"></tbody>
      </table>
    </div>

    <!-- Pagination + Export -->
    <div class="flex justify-between items-center mt-4 text-sm">
      <span id="pageInfo" class="text-gray-600 dark:text-gray-300">Halaman 1</span>
      <div class="flex gap-2">
        <button id="prevPage"
          class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
          ‚óÄÔ∏è
        </button>
        <button id="nextPage"
          class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
          ‚ñ∂Ô∏è
        </button>
        <button id="downloadExcel"
          class="px-3 py-1 rounded bg-green-600 text-white font-semibold hover:bg-green-700">
          ‚¨áÔ∏è Excel
        </button>
        <button id="downloadPDF"
          class="px-3 py-1 rounded bg-red-600 text-white font-semibold hover:bg-red-700">
          ‚¨áÔ∏è PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Export Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    const tbody = document.querySelector("tbody");
    const searchBox = document.getElementById("searchBox");
    const pageInfo = document.getElementById("pageInfo");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    // CSV Google Sheets
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7sTDwqB-dKMbt6-E6ux3C-_8F48Au-bJJcxqAs8ZiEcf4duOII3G2uE9Y6Psu8xIMkBnvvqMXCkzR/pub?gid=0&single=true&output=csv";

    // Format rupiah
    const formatRupiah = (value) => {
      if (!isNaN(value) && value !== "") {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0
        }).format(Number(value));
      }
      return value ?? "";
    };

    function renderTable() {
      tbody.innerHTML = "";
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredData.slice(start, end);

      pageData.forEach((row) => {
        const tr = document.createElement("tr");
        tr.classList.add("hover:bg-gray-50", "dark:hover:bg-gray-700");

        row.forEach((cell, index) => {
          const td = document.createElement("td");
          td.className = "border p-2";
          if (index === 13 || index === 14) {
            td.textContent = formatRupiah(cell);
          } else {
            td.textContent = cell ?? "";
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      pageInfo.textContent = `Halaman ${currentPage} dari ${Math.ceil(filteredData.length / rowsPerPage)}`;
    }

    function applySearch() {
      const keyword = searchBox.value.toLowerCase();
      filteredData = allData.filter(row => row.some(cell => (cell + "").toLowerCase().includes(keyword)));
      currentPage = 1;
      renderTable();
    }

    searchBox.addEventListener("input", applySearch);
    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });
    nextPageBtn.addEventListener("click", () => {
      if (currentPage < Math.ceil(filteredData.length / rowsPerPage)) {
        currentPage++;
        renderTable();
      }
    });

    // Ambil header dengan colspan/rowspan
    function getTableHeadersWithMerge() {
      const rows = [];
      document.querySelectorAll("#dataTable thead tr").forEach(tr => {
        const cells = [];
        tr.querySelectorAll("th").forEach(th => {
          const text = th.innerText.replace(/\n/g, " ");
          const colspan = parseInt(th.getAttribute("colspan") || "1");
          const rowspan = parseInt(th.getAttribute("rowspan") || "1");
          cells.push({ text, colspan, rowspan });
        });
        rows.push(cells);
      });
      return rows;
    }

    // Auto load Google Sheets
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const rows = text.split("\n").map(r => r.split(",").map(c => c.trim()));

        // Ambil data mulai A3:U (baris index 2 ke bawah, total 21 kolom)
        allData = rows.slice(2).map(r => r.slice(0, 21));

        // Buang baris header duplikat
        const headersToSkip = ["Kode Barang", "Nama Barang", "Nomor Polisi", "Nomor Rangka", "Nomor BPKB"];
        allData = allData.filter(r => !headersToSkip.includes(r[0]) && !headersToSkip.includes(r[1]));

        filteredData = [...allData];
        renderTable();
      } catch (err) {
        console.error("Gagal load sheet:", err);
      }
    });

    // Export ke Excel (dengan merge + subheader)
    document.getElementById("downloadExcel").addEventListener("click", () => {
      const headerRows = getTableHeadersWithMerge();

      // Konversi ke AOA (Array of Arrays)
      const aoa = headerRows.map(row =>
        row.flatMap(cell => [cell.text, ...Array(cell.colspan - 1).fill(null)])
      );
      aoa.push(...filteredData);

      const ws = XLSX.utils.aoa_to_sheet(aoa);

      // Tambah merge sesuai colspan/rowspan
      ws['!merges'] = [];
      let rowIndex = 0;
      headerRows.forEach(row => {
        let colIndex = 0;
        row.forEach(cell => {
          if (cell.colspan > 1 || cell.rowspan > 1) {
            ws['!merges'].push({
              s: { r: rowIndex, c: colIndex },
              e: { r: rowIndex + cell.rowspan - 1, c: colIndex + cell.colspan - 1 }
            });
          }
          colIndex += cell.colspan;
        });
        rowIndex++;
      });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data");
      XLSX.writeFile(wb, "data.xlsx");
    });

    // Export ke PDF (pakai jspdf.umd)
    document.getElementById("downloadPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const headerRows = getTableHeadersWithMerge();
      const simpleHead = headerRows.map(row => row.map(cell => cell.text));

      const doc = new jsPDF('l', 'mm', 'a4');
      doc.text("Data Barang", 14, 10);
      doc.autoTable({
        head: simpleHead,
        body: filteredData,
        startY: 15,
        styles: { fontSize: 7 },
        headStyles: { fillColor: [41, 128, 185] }
      });
      doc.save("data.pdf");
    });

    // Dark mode toggle
    document.getElementById("toggleDark").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      document.getElementById("toggleDark").textContent =
        document.documentElement.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    });
  </script>
</body>
</html>
